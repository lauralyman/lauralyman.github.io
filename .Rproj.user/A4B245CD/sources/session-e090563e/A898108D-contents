---
title: "Lab 4: Linear Regression with a Binary Outcome (Continued)"
author: "STAT 244"
# format: live-html
# engine: knitr
format:
    pdf:
      keep-tex: true
      include-in-header:
         text: |
           \usepackage{fvextra}
           \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
            \DefineVerbatimEnvironment{OutputCode}{Verbatim}{breaklines,commandchars=\\\{\}}
    html:
      self-contained: true
      grid:
        margin-width: 200px
      code-fold: false
      # callout-appearance: minimal
editor: visual

# You can change the color theme of the rendered document 
theme: default
---

```{r setup, include=FALSE}
# This chunk includes set-up options
# The 'include = FALSE` means that it is not shown when you
# knit
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```

::: {.callout-tip collapse="true" icon="true"}
# Getting Started

1.  Download the `.qmd` and `.csv` files from Moodle and save them someplace on your computer where you can easily find again (the two files need to be in the same folder together). I strongly recommend that you save these files in a folder dedicated to activities for this class, not in your Downloads.

2.  Open the Quarto file in RStudio: `File > Open File... >`. (If you're working on the MHC RStudio server, you need to upload the file first: go to the `Files` panel, then click `Upload`. Upload both the Rmd and the csv file.)

3.  Update the author and date in the YAML header of this file.

4.  Click the `Knit` button. If successful, you should have a new window pop up with a nice looking HTML document.

**Ask for help** if you encounter issues on any of the steps above. Once you've successfully made it through these steps, you can continue.
:::

## Loading Packages

As always, we start by loading all the packages that we'll need. We're going to be completing the following tasks:

-   reading a data set into R;
-   working with a data set (e.g., using the pipe (`%>%`) function to split commands across multiple lines, calculating numerical summaries);
-   creating mosaic plots.

We'll need a different R package for each of these tasks. Use the code chunk below to load the necessary packages into R, now including the `ggmosaic` library.

```{r load-packages, message = FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(ggmosaic)
```

## Data Context

The *Titanic* was a British passenger ship that famously sank in 1912 after hitting an iceberg in the North Atlantic Ocean. Approximately 2,200 passengers were on board the Titanic, and it's estimated that 1,500 of them did not survive the crash. Historians have worked diligently to collect data on the passengers that were aboard the Titanic.

We have data for 1,313 passengers, where the following information is available for each passenger:

-   `Name`: name
-   `PClass`: ticket class (1st, 2nd, 3rd)
-   `Age`: age (years)
-   `Sex`: binary sex (female, male)
-   `Survived`: indicator that the passenger survived (1 = survived, 0 = died)

## Loading the Titanic Data

Download `titanic.csv` from Moodle (if you haven't already) and make sure it's saved in the same folder as this `.qmd` file. Add code to the code chunk below to read the data set into R and save it as an object called `titanic`.

```{r load-data, message = FALSE}
# Load titanic data here
titanic = read_csv("titanic.csv")
```

Open up a new window to view these data and/or add code to the code chunk below to look at the first few rows.

```{r look-at-data}
# Code to view data here
head(titanic)
```

::: {.callout-important collapse="true"}
## Important Note on Loading Data

-   Do **not** use the command `data("titanic")` in your code. You need to run `titanic <- read_csv("titanic")` to properly import the CSV file. Otherwise, your code might use the **wrong dataset**.

-   Why? The `data()` command is used only when we want a pre-loaded dataset that comes with R/RStudio (i.e., a dataset that we don't have to import with the `read_csv()` command); an example of this might be NHANES, which comes with our RStudio distribution.

-   Newer versions of R/RStudio come with a pre-loaded dataset called "titanic", which can be loaded by calling `data("titanic")` (or sometimes is pre-loaded *without* you running this command).

-   **Even when you download/import the `titanic.csv` file provided here via `titanic <- read_csv("titanic")`, if you call `data("titanic")`*anywhere afterward* in your .Rmd file, the object `titanic` will reference the pre-loaded (wrong) version.** Alternatively, if you **forget to download/import the `titanic.csv` file provided here via `titanic <- read_csv("titanic")`, your code may use the wrong version.**
:::

## New Research Question

Now suppose our question of interest is this: *Were Titanic passengers in 1st class more likely to survive than passengers in other classes?*

::: {.callout-tip collapse="true"}
# Exercise: Data Context

Based on the new research question, which variable is our response, and which variable is our explanatory variable? What types of variables are these?

-   Response variable: YOUR ANSWER HERE
-   Explanatory variable: YOUR ANSWER HERE
:::

#### Data Cleaning: Filtering out `NA` Values

command-shift-M or ctrl-shift-M to make %\>%

```{r}
# CODE HERE TO FILTER OUT MISSING VALUES

titanic = titanic %>% filter(!is.na(PClass))
```

#### Visual Summary

Let's create a mosaic plot to visually compare passenger class and survival status (two categorical variables). Make sure to update the x-axis, y-axis, and color legend labels to make this plot more informative.

```{r message = FALSE, warning = FALSE}
# Create a mosaic plot
titanic %>%
  ggplot() +
  geom_mosaic(aes(x = product(Survived, PClass), fill = Survived)) +
  xlab('Passenger Class') + 
  ylab('Survived? (1 for Yes, 0 for No)') +
  scale_fill_manual('Survived?', values = c("skyblue", "steelblue"))
```

::: {.callout-tip collapse="true"}
# Exercise: Interpret the Visualization

Write a short description that summarizes the information gained from your plot.

People in 1st class were most likely to survive, followed by 2nd class, followed by 3rd class.

Based on the relative widths, 3rd class had the most people, followed by 1st class, followed by 2nd class.
:::

#### Contingency Table

```{r}
# CODE FOR COUNT HERE
count(titanic, Survived, PClass)
```

Use the output from the `count` function to fill out the following table (which is sometimes called a *contingency table*).

|           | Survived | Did Not Survive | (Total) |
|-----------|----------|-----------------|---------|
| 1st Class | 193      | 129             | 322     |
| 2nd Class | 119      | 160             | 279     |
| 3rd Class | 138      | 573             | 711     |
| (Total)   | 450      | 862             | 1312    |

::: {.callout-tip collapse="true"}
# Exercise: Using the Contingency Table

Use your table above to estimate the following.

-   The probability of surviving among 1st class passengers $\approx$ 193/322 = .599
-   The probability of surviving among 2nd class passengers $\approx$ 119/279 = .427
-   The probability of surviving among 3rd class passengers $\approx$ .194
:::

::: {.callout-tip collapse="true"}
# Exercise: Recovering $\hat\beta$ Coefficients

Use your answers to the last exercise to estimate:

-   the difference in the probability of surviving, comparing 2nd class passengers to 1st class passengers (i.e., how much lower is the probability of 2nd class passengers surviving as compared to 1st class passengers?)

-   the difference in the probability of surviving, comparing 3rd class passengers to 1st class passengers (i.e., how much lower is the probability of 3rd class passengers as compared to 1st class passengers?)

Second class passengers have a chance of surviving that is (.599 - .427) = .172 (or 17.2%) lower than that of first class passengers.

Third class passengers have a chance of surviving that is (.599 - .194) = 0.405 (or 40.5%) lower than that of first class passengers.
:::

#### Model Equation

Given the **new** research question, our **model equation** is now

$$\mathbb{P}(Survived = 1 \mid PClass) = \beta_0 + \beta_1 I(PClass = 2nd) + \beta_2 I(PClass = 3rd)$$

#### Perform Regression

```{r}
titanic %>% with(lm(Survived ~ PClass))
```

::: {.callout-tip collapse="true"}
# Exercise: Interpret $\hat\beta$ Coefficients

Write out an interpretation of each of the coefficients in this new linear regression model. Use the estimates provided by the `lm()` R code.

-   $\hat\beta_0$ interpretation: The probability of surviving for first class is about .5994 (or 59.94%)\
    \
    \[Chance of surviving for 2nd class\] = beta1 + \[chance of surviving for 1st class\]\
    $\approx$ -.1729 + \[chance of surviving for 1st class\]\
    = 17.29% lower than the chance of surviving for\
    first class
-   $\hat\beta_1$ interpretation: The probability of surviving for second class is about .1729 (or 17.29%) lower than that of first class.
-   $\hat\beta_2$ interpretation: The probability of surviving for third class is about .4053 (or 40.53%) lower than that of first class.

How do these interpretations compare to what you found in the previous exercise?
:::

## Multiple Linear Regression

Now we consider using class (via the variable `PClass`), age, *and* (binary) sex to predict survival probabilities. Our model equation is:

$$\mathbb{P}(Survived = 1 \mid PClass, Age, Sex) = \beta_0 + \beta_1 I(PClass = 2nd) + \beta_2 I(PClass = 3rd) + \beta_3 (Age) + \beta_4 I(Sex = Male) $$

Before we perform regression, let's be sure to filter out any missing values:

```{r}
# CODE HERE TO FILTER OUT MISSING VALUES
titanic = titanic %>% filter(!is.na(Age))
titanic = titanic %>% filter(!is.na(Sex))
```

We can perform regression with the following code to get estimates of $\beta_0, \ldots, \beta_3$.

```{r}
# YOUR CODE HERE
mod <- titanic %>% with(lm(Survived ~ PClass + Age + Sex))
```

::: {.callout-tip collapse="true"}
# Exercise: Predict Survival Probabilities

Use the final model to predict the probability of survival for Rose (a 17 year old female in 1st class) and Jack (a 20 year old male in 3rd class). Show your work.

For Rose:

$$\mathbb{P}(Survived = 1 \mid PClass = 1st, Age = 17, Sex = Female) = ... $$ For Jack:

$$\mathbb{P}(Survived = 1 \mid PClass = 3rd, Age = 20, Sex = Male) = ... $$

```{r}
# Calculate "by hand" for Rose

# Calculate "by hand" for Jack
```

```{r}
# Use predict.lm function instead to get survival probabilities
predict.lm(mod, newdata = data.frame(PClass = "1st", Age = 17, Sex = "female"))

predict.lm(mod, newdata = data.frame(PClass = "3rd", Age = 20, Sex = "male"))
```
:::
